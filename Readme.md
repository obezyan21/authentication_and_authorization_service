# Система аутентификации и авторизации

Backend-приложение для управления пользователями и разграничения прав доступа к ресурсам.

## Описание системы

Система реализует собственную модель управления доступом на основе ролей с гибкой настройкой прав для каждой роли.

## Архитектура системы доступа

### Модель управления доступом

Система использует **ролевую модель доступа (RBAC)** с дополнительной таблицей разрешений, которая позволяет гибко настраивать права для каждой роли.

### Структура базы данных

#### Таблица `users` (Пользователи)

Хранит информацию о пользователях системы.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Integer | Уникальный идентификатор |
| `name` | String(100) | Имя пользователя |
| `surname` | String(100) | Фамилия пользователя |
| `email` | String(255) | Email (уникальный) |
| `hashed_password` | String(255) | Хешированный пароль |
| `role` | Enum(UserRole) | Роль пользователя |
| `is_active` | Boolean | Статус активности (для мягкого удаления) |
| `created_at` | DateTime | Дата создания |
| `updated_at` | DateTime | Дата последнего обновления |

#### Таблица `permissions` (Права доступа)

Хранит правила доступа для каждой роли к каждому ресурсу и действию.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Integer | Уникальный идентификатор |
| `role` | Enum(UserRole) | Роль пользователя |
| `resource` | String(50) | Название ресурса (например, "products", "orders") |
| `action` | String(20) | Действие (например, "read", "create", "update", "delete") |
| `allowed` | Boolean | Разрешено ли действие (True/False) |

**Уникальное ограничение**: Комбинация `(role, resource, action)` должна быть уникальной.

### Роли пользователей

Система поддерживает 4 роли:

1. **Администратор (ADMIN)**
   - Полный доступ ко всем ресурсам и действиям
   - Может управлять правами доступа других пользователей

2. **Менеджер (MANAGER)**
   - Может читать, создавать и обновлять продукты
   - Не может удалять продукты
   - Может управлять заказами (кроме удаления)
   - Может просматривать отчеты

3. **Пользователь (USER)**
   - Может только читать продукты
   - Может создавать заказы
   - Не может просматривать отчеты

4. **Читатель (VIEWER)**
   - Может только читать продукты и заказы
   - Не может создавать, обновлять или удалять

### Механизм проверки прав доступа

1. **Идентификация пользователя**:
   - При логине пользователь получает JWT токен
   - Токен хранится в HTTP-only cookie
   - При каждом запросе токен проверяется и извлекается `user_id`

2. **Проверка прав**:
   - Для каждого защищенного ресурса выполняется проверка:
     - Получается роль пользователя из таблицы `users`
     - Ищется правило в таблице `permissions` для комбинации `(role, resource, action)`
     - Если правило найдено и `allowed = True`, доступ разрешен
     - Если правило не найдено или `allowed = False`, доступ запрещен (403 Forbidden)

3. **Обработка ошибок**:
   - **401 Unauthorized**: Пользователь не аутентифицирован (нет токена или токен невалиден)
   - **403 Forbidden**: Пользователь аутентифицирован, но не имеет прав на выполнение действия

### Ресурсы системы

Система поддерживает следующие Mock-объекты:

- **products** (Продукты)
  - `read` - просмотр списка и деталей
  - `create` - создание нового продукта
  - `update` - обновление продукта
  - `delete` - удаление продукта

- **orders** (Заказы)
  - `read` - просмотр списка заказов
  - `create` - создание заказа
  - `update` - обновление заказа
  - `delete` - удаление заказа

- **reports** (Отчеты)
  - `read` - просмотр отчетов

## API Endpoints

### Аутентификация

- `POST /register` - Регистрация нового пользователя
- `POST /login` - Вход в систему
- `POST /logout` - Выход из системы
- `PATCH /me` - Обновление профиля текущего пользователя
- `PATCH /me/delete_user` - Мягкое удаление аккаунта (с автоматическим logout)

### Управление правами доступа (только для администратора)

- `GET /admin/permissions` - Получить все правила доступа
- `POST /admin/permissions` - Создать новое правило доступа
- `PATCH /admin/permissions/{permission_id}` - Обновить правило доступа
- `DELETE /admin/permissions/{permission_id}` - Удалить правило доступа

### Просмотр своих прав

- `GET /me/permissions` - Получить права доступа текущего пользователя

### Mock-View для бизнес-объектов

- `GET /products` - Список продуктов (требует `products:read`)
- `GET /products/{product_id}` - Детали продукта (требует `products:read`)
- `POST /products` - Создать продукт (требует `products:create`)
- `PUT /products/{product_id}` - Обновить продукт (требует `products:update`)
- `DELETE /products/{product_id}` - Удалить продукт (требует `products:delete`)
- `GET /orders` - Список заказов (требует `orders:read`)
- `GET /reports` - Список отчетов (требует `reports:read`)

## Установка и запуск

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```env
SECRET_KEY=YOUR-SECRET-KEY
ALGORITHM=HS256
```

### 3. Инициализация базы данных

```bash
# Создание таблиц
curl -X POST http://localhost:8000/db

# Или через Python
python -m app.scripts.init_test_data
```

### 4. Заполнение тестовыми данными

```bash
python -m app.scripts.init_test_data
```

Это создаст:
- 5 тестовых пользователей (admin, manager, user, viewer, deleted)
- Правила доступа для всех ролей

### 5. Запуск сервера

```bash
uvicorn app.main:app --reload
```

## Тестовые пользователи

После инициализации доступны следующие пользователи:

| Email | Пароль | Роль |
|-------|--------|------|
| admin@example.com | admin123 | Администратор |
| manager@example.com | manager123 | Менеджер |
| user@example.com | user123 | Пользователь |
| viewer@example.com | viewer123 | Читатель |
| deleted@example.com | deleted123 | Пользователь (неактивный) |

## Примеры использования

### 1. Регистрация пользователя

```bash
curl -X POST http://localhost:8000/register \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Иван",
    "surname": "Иванов",
    "email": "ivan@example.com",
    "password": "password123",
    "password_confirm": "password123",
    "role": "Пользователь"
  }'
```

### 2. Вход в систему

```bash
curl -X POST http://localhost:8000/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "user123"
  }' \
  -c cookies.txt
```

### 3. Получение списка продуктов (требует аутентификации и прав)

```bash
curl -X GET http://localhost:8000/products \
  -b cookies.txt
```

### 4. Создание правила доступа (только для администратора)

```bash
curl -X POST http://localhost:8000/admin/permissions \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{
    "role": "Пользователь",
    "resource": "products",
    "action": "create",
    "allowed": true
  }'
```

## Технологии

- **FastAPI** - веб-фреймворк
- **SQLAlchemy** - ORM для работы с БД
- **aiosqlite** - асинхронный драйвер для SQLite
- **python-jose** - работа с JWT токенами
- **passlib** - хеширование паролей (bcrypt)
- **Pydantic** - валидация данных
